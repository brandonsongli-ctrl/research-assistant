<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¦æœ¯å¼•ç”¨åŠ©æ‰‹ | Research Citation Assistant</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f6fa;
      --surface: #ffffff;
      --border: #e1e4e8;
      --primary: #4f6ef7;
      --primary-hover: #3d5ce8;
      --text: #1a1d27;
      --muted: #6b7280;
      --tag-bg: #eef2ff;
      --tag-color: #4f6ef7;
      --success: #10b981;
      --shadow: 0 1px 4px rgba(0,0,0,.08);
    }

    [data-theme="dark"] {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --primary: #58a6ff;
      --primary-hover: #79b8ff;
      --text: #e6edf3;
      --muted: #8b949e;
      --tag-bg: #1f2937;
      --tag-color: #58a6ff;
      --success: #3fb950;
      --shadow: 0 1px 4px rgba(0,0,0,.4);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header .logo {
      width: 32px; height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 700; font-size: 14px;
    }

    header h1 { font-size: 17px; font-weight: 600; }
    header span { font-size: 13px; color: var(--muted); margin-left: 4px; }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      max-height: calc(100vh - 56px);
    }

    .panel {
      overflow-y: auto;
      padding: 24px;
    }

    .panel-left {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-right {
      background: var(--bg);
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 280px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.7;
      resize: vertical;
      font-family: inherit;
      background: var(--surface);
      color: var(--text);
      transition: border-color .15s;
    }

    textarea:focus { outline: none; border-color: var(--primary); }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .option-group { display: flex; flex-direction: column; gap: 6px; }
    .option-group label { font-size: 12px; font-weight: 500; color: var(--muted); }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: var(--surface);
      color: var(--text);
      transition: border-color .15s;
    }

    select:focus, input:focus { outline: none; border-color: var(--primary); }

    .year-row { display: flex; gap: 8px; align-items: center; }
    .year-row span { font-size: 12px; color: var(--muted); white-space: nowrap; }

    .btn-primary {
      width: 100%;
      padding: 11px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, opacity .15s;
    }

    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { opacity: .55; cursor: not-allowed; }

    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results */
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .result-count {
      font-size: 13px;
      color: var(--muted);
    }

    .btn-export {
      padding: 6px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: border-color .15s;
    }

    .btn-export:hover { border-color: var(--primary); color: var(--primary); }

    .export-group { display: flex; gap: 6px; }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .sentence-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 6px;
    }

    .sentence-text {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
      padding: 8px 10px;
      background: var(--tag-bg);
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      margin-bottom: 12px;
    }

    .citations-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 8px;
    }

    .citation-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: border-color .15s;
    }

    .citation-item:hover { border-color: var(--primary); }

    .citation-body { flex: 1; min-width: 0; }

    .citation-formatted {
      font-size: 12.5px;
      line-height: 1.6;
      color: var(--text);
      word-break: break-word;
    }

    .citation-meta {
      display: flex;
      gap: 8px;
      margin-top: 5px;
      flex-wrap: wrap;
    }

    .citation-tag {
      font-size: 11px;
      background: var(--tag-bg);
      color: var(--tag-color);
      padding: 2px 7px;
      border-radius: 4px;
      font-weight: 500;
    }

    .citation-abstract {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.5;
    }

    .citation-link {
      font-size: 11px;
      color: var(--primary);
      text-decoration: none;
      word-break: break-all;
    }

    .citation-link:hover { text-decoration: underline; }

    .btn-copy {
      flex-shrink: 0;
      padding: 5px 10px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      color: var(--muted);
      font-family: inherit;
      transition: all .15s;
      white-space: nowrap;
    }

    .btn-copy:hover { border-color: var(--primary); color: var(--primary); }
    .btn-copy.copied { border-color: var(--success); color: var(--success); }

    #text-highlight mark {
      background: #fff3cd;
      border-radius: 3px;
      padding: 0 2px;
    }

    .btn-abstract-toggle {
      background: none;
      border: none;
      font-size: 11px;
      color: var(--primary);
      cursor: pointer;
      padding: 2px 0;
      font-family: inherit;
    }
    .btn-abstract-toggle:hover { text-decoration: underline; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .empty-state p { font-size: 14px; line-height: 1.6; }

    .error-msg {
      background: #fff1f0;
      border: 1px solid #ffa39e;
      color: #cf1322;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 13px;
    }

    .text-stats {
      font-size: 11px;
      color: var(--muted);
      text-align: right;
      margin-top: 4px;
    }

    .card-toggle {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-toggle:hover .sentence-text { border-left-color: var(--primary-hover); }

    .toggle-icon {
      font-size: 12px;
      color: var(--muted);
      transition: transform .2s;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .card-body { overflow: hidden; transition: max-height .25s ease; }
    .card-body.collapsed { max-height: 0 !important; }

    .history-section { margin-top: 4px; }
    .history-label {
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      user-select: none;
    }
    .history-label:hover { color: var(--text); }
    .history-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: border-color .15s;
    }
    .history-item:hover { border-color: var(--primary); color: var(--primary); }
    .history-item-time { color: var(--muted); flex-shrink: 0; }
    .history-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .history-item-del { color: var(--muted); flex-shrink: 0; font-size: 14px; line-height: 1; }
    .history-item-del:hover { color: #cf1322; }

    @media (max-width: 768px) {
      .main { grid-template-columns: 1fr; max-height: none; }
      .panel-left { border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">å¼•</div>
  <h1>å­¦æœ¯å¼•ç”¨åŠ©æ‰‹</h1>
  <span>Research Citation Assistant</span>
  <button id="theme-btn" onclick="toggleTheme()" style="margin-left:auto;background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer;color:var(--muted);font-family:inherit;transition:all .15s;" title="åˆ‡æ¢æš—è‰²æ¨¡å¼">ğŸŒ™</button>
</header>

<div class="main">
  <!-- Left: Input Panel -->
  <div class="panel panel-left">
    <div>
      <div class="section-title">è®ºæ–‡æ–‡æœ¬ / Paper Text</div>
      <textarea id="text-input"
        placeholder="ç²˜è´´æ‚¨çš„è®ºæ–‡æˆ–æ®µè½æ–‡æœ¬ï¼ŒåŠ©æ‰‹å°†è‡ªåŠ¨è¯†åˆ«éœ€è¦å¼•ç”¨çš„å¥å­å¹¶æœç´¢ç›¸å…³æ–‡çŒ®ã€‚

Paste your paper or paragraph text here. The assistant will automatically detect sentences that need citations and find supporting literature."
        oninput="updateStats()"
      ></textarea>
      <div class="text-stats" id="text-stats">0 è¯ / 0 å­—ç¬¦</div>
      <div id="text-highlight" style="display:none;margin-top:8px;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;line-height:1.7;background:var(--surface);white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto;"></div>
      <div class="history-section" id="history-section" style="display:none;">
        <div class="history-label" onclick="toggleHistory()">
          <span id="history-toggle-icon">â–¶</span> å†å²è®°å½• / History (<span id="history-count">0</span>)
        </div>
        <div class="history-list" id="history-list" style="display:none;"></div>
      </div>
    </div>

    <div>
      <div class="section-title">å¼•ç”¨é€‰é¡¹ / Options</div>
      <div class="options-grid">
        <div class="option-group">
          <label>å¼•ç”¨æ ¼å¼ / Citation Format</label>
          <select id="format-select">
            <option value="apa">APA</option>
            <option value="mla">MLA</option>
            <option value="chicago">Chicago</option>
            <option value="ieee">IEEE</option>
            <option value="harvard">Harvard</option>
            <option value="vancouver">Vancouver</option>
            <option value="bibtex">BibTeX</option>
          </select>
        </div>

        <div class="option-group">
          <label>æ¥æºç­›é€‰ / Source Filter</label>
          <input type="text" id="sources-input" placeholder="e.g. Nature, Science" />
        </div>

        <div class="option-group">
          <label>å­¦ç§‘é¢†åŸŸ / Field of Study</label>
          <select id="field-of-study">
            <option value="">å…¨éƒ¨ / All</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Medicine">Medicine</option>
            <option value="Biology">Biology</option>
            <option value="Physics">Physics</option>
            <option value="Mathematics">Mathematics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Psychology">Psychology</option>
            <option value="Engineering">Engineering</option>
            <option value="Economics">Economics</option>
            <option value="Sociology">Sociology</option>
            <option value="Environmental Science">Environmental Science</option>
            <option value="Neuroscience">Neuroscience</option>
          </select>
        </div>

        <div class="option-group">
          <label>æ¯å¥ç»“æœæ•° / Results per Sentence</label>
          <select id="results-per-sentence">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="8">8</option>
            <option value="10">10</option>
          </select>
        </div>

        <div class="option-group">
          <label>æ’åºæ–¹å¼ / Sort By</label>
          <select id="sort-by">
            <option value="citations">å¼•ç”¨æ¬¡æ•° / Citation Count</option>
            <option value="relevance">ç›¸å…³æ€§ / Relevance</option>
          </select>
        </div>

        <div class="option-group">
          <label>æœ€ä½å¼•ç”¨é‡ / Min Citations</label>
          <select id="min-citations">
            <option value="0">ä¸é™ / Any</option>
            <option value="10">â‰¥ 10</option>
            <option value="50">â‰¥ 50</option>
            <option value="100">â‰¥ 100</option>
            <option value="500">â‰¥ 500</option>
            <option value="1000">â‰¥ 1000</option>
          </select>
        </div>

        <div class="option-group" style="grid-column: 1 / -1;">
          <label>å¹´ä»½èŒƒå›´ / Year Range</label>
          <div class="year-row">
            <input type="number" id="year-start" placeholder="2000" min="1900" max="2026" />
            <span>â€”</span>
            <input type="number" id="year-end" placeholder="2026" min="1900" max="2026" />
          </div>
        </div>
      </div>
    </div>

    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
      <input type="checkbox" id="open-access-only" style="width:auto;" />
      ä»…å¼€æ”¾è·å– / Open Access Only
    </label>

    <button class="btn-primary" id="find-btn" onclick="findCitations()">
      æŸ¥æ‰¾å¼•ç”¨ / Find Citations
    </button>
  </div>

  <!-- Right: Results Panel -->
  <div class="panel panel-right" id="results-panel">
    <div class="empty-state">
      <div class="icon">ğŸ“„</div>
      <p>ç²˜è´´æ–‡æœ¬åç‚¹å‡»ã€ŒæŸ¥æ‰¾å¼•ç”¨ã€<br/>ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«éœ€è¦å¼•ç”¨çš„å¥å­<br/>å¹¶ä»å­¦æœ¯æ•°æ®åº“ä¸­åŒ¹é…ç›¸å…³æ–‡çŒ®ã€‚</p>
      <p style="margin-top:12px; font-size:12px;">Paste text and click "Find Citations" to begin.</p>
    </div>
  </div>
</div>

<script>
  let lastResults = [];

  async function findCitations() {
    const text = document.getElementById('text-input').value.trim();
    if (!text) {
      alert('è¯·è¾“å…¥è®ºæ–‡æ–‡æœ¬ã€‚\nPlease enter paper text.');
      return;
    }

    const btn = document.getElementById('find-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>æœç´¢ä¸­ / Searching...';

    const panel = document.getElementById('results-panel');
    panel.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>æ­£åœ¨åˆ†ææ–‡æœ¬å¹¶æœç´¢æ–‡çŒ®...<br/>Analyzing text and searching literature...</p></div>';

    const payload = {
      text,
      format: document.getElementById('format-select').value,
      sources: document.getElementById('sources-input').value,
      year_start: document.getElementById('year-start').value || null,
      year_end: document.getElementById('year-end').value || null,
      results_per_sentence: parseInt(document.getElementById('results-per-sentence').value, 10),
      open_access_only: document.getElementById('open-access-only').checked,
      fields_of_study: document.getElementById('field-of-study').value,
      min_citation_count: parseInt(document.getElementById('min-citations').value, 10),
      sort_by: document.getElementById('sort-by').value,
    };

    // Stream results sentence by sentence
    const streamBuffer = {};
    let streamCount = 0;
    const fmt = payload.format.toUpperCase();

    function flushStreamResults() {
      const sortedKeys = Object.keys(streamBuffer).map(Number).sort((a,b)=>a-b);
      const ordered = sortedKeys.map(k => streamBuffer[k]);
      lastResults = ordered;
      if (!ordered.length) return;
      // Re-render header + append new cards
      const countEl = panel.querySelector('.result-count');
      if (countEl) {
        countEl.textContent = `æ£€æµ‹åˆ° ${ordered.length} ä¸ªéœ€å¼•ç”¨çš„å¥å­ / ${ordered.length} sentence(s) need citations`;
      } else {
        renderResults(ordered, fmt);
        document.querySelectorAll('.card-body').forEach(el => { el.style.maxHeight = el.scrollHeight + 'px'; });
      }
    }

    try {
      const resp = await fetch('/api/stream-citations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        panel.innerHTML = `<div class="error-msg">${err.error || 'è¯·æ±‚å¤±è´¥ / Request failed.'}</div>`;
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let sseBuffer = '';

      // Show skeleton while waiting
      panel.innerHTML = `<div class="result-header">
        <span class="result-count">æ­£åœ¨æœç´¢... / Searching...</span>
        <div class="export-group">
          <button class="btn-export" onclick="exportAll('txt')">TXT</button>
          <button class="btn-export" onclick="exportAll('bib')">BibTeX</button>
          <button class="btn-export" onclick="exportAll('ris')">RIS</button>
          <button class="btn-export" onclick="exportAll('csv')">CSV</button>
        </div>
      </div>`;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        sseBuffer += decoder.decode(value, { stream: true });
        const lines = sseBuffer.split('\n');
        sseBuffer = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          try {
            const event = JSON.parse(line.slice(6));
            if (event.type === 'result') {
              streamBuffer[event.index] = event.data;
              streamCount++;
              // Append new card without full re-render
              const idx = event.index;
              const r = event.data;
              const bodyId = `card-body-${idx}`;
              let html = `<div class="result-card" id="stream-card-${idx}">
                <div class="card-toggle" onclick="toggleCard('${bodyId}', this)">
                  <div>
                    <div class="sentence-label">
                      å¥å­ ${streamCount} / Sentence ${streamCount}
                      ${r.reason ? `<span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted);margin-left:6px;">â€” ${escHtml(r.reason)}</span>` : ''}
                    </div>
                    <div class="sentence-text">${escHtml(r.sentence)}</div>
                  </div>
                  <span class="toggle-icon">â–²</span>
                </div>
                <div class="card-body" id="${bodyId}">
                <div class="citations-label" style="margin-top:8px;">æ¨èå¼•ç”¨ (${fmt}) / Suggested Citations</div>`;

              r.citations.forEach((c, ci) => {
                const idBase = `cit-${idx}-${ci}`;
                html += `<div class="citation-item">
                  <div class="citation-body">
                    <div class="citation-formatted" id="${idBase}">${escHtml(c.formatted)}</div>
                    <div class="citation-meta">`;
                if (c.year) html += `<span class="citation-tag">${c.year}</span>`;
                if (c.venue) html += `<span class="citation-tag">${escHtml(c.venue)}</span>`;
                if (c.citation_count != null) html += `<span class="citation-tag">å¼•ç”¨ ${c.citation_count}</span>`;
                if (c.pdf_url) html += `<span class="citation-tag" style="background:#e6f4ea;color:#1a7f37;">Open Access</span>`;
                if (c.doi_valid === true)  html += `<span class="citation-tag" style="background:#e6f4ea;color:#1a7f37;">DOI âœ“</span>`;
                if (c.doi_valid === false) html += `<span class="citation-tag" style="background:#fff1f0;color:#cf1322;">DOI âœ—</span>`;
                html += `</div>`;
                if (c.abstract) {
                  const absId = `abs-${idx}-${ci}`;
                  const preview = c.abstract.length > 200 ? escHtml(c.abstract.slice(0, 200)) + 'â€¦' : escHtml(c.abstract);
                  html += `<div class="citation-abstract" id="${absId}-preview">${preview}</div>`;
                  if (c.abstract.length > 200) {
                    html += `<div class="citation-abstract" id="${absId}-full" style="display:none;">${escHtml(c.abstract)}</div>`;
                    html += `<button class="btn-abstract-toggle" onclick="toggleAbstract('${absId}', this)">å±•å¼€æ‘˜è¦ â–¾</button>`;
                  }
                }
                const linkUrl = c.pdf_url || c.url;
                if (linkUrl) {
                  const label = c.pdf_url ? `PDF: ${escHtml(c.pdf_url)}` : escHtml(c.url);
                  html += `<a class="citation-link" href="${escHtml(linkUrl)}" target="_blank" rel="noopener">${label}</a>`;
                }
                html += `</div><button class="btn-copy" onclick="copyCitation('${idBase}', this)">å¤åˆ¶</button></div>`;
              });
              html += `</div></div>`;

              panel.insertAdjacentHTML('beforeend', html);
              const body = document.getElementById(bodyId);
              if (body) body.style.maxHeight = body.scrollHeight + 'px';

              // Update count
              const countEl = panel.querySelector('.result-count');
              if (countEl) countEl.textContent = `å·²æ‰¾åˆ° ${streamCount} ä¸ª / Found ${streamCount} sentence(s)`;

            } else if (event.type === 'done') {
              if (!streamCount) {
                panel.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><p>æœªæ£€æµ‹åˆ°éœ€è¦å¼•ç”¨çš„å¥å­ã€‚<br/>No sentences requiring citations were detected.</p></div>`;
              } else {
                const countEl = panel.querySelector('.result-count');
                if (countEl) countEl.textContent = `æ£€æµ‹åˆ° ${streamCount} ä¸ªéœ€å¼•ç”¨çš„å¥å­ / ${streamCount} sentence(s) need citations`;
                if (lastResults.length) saveHistory(text, lastResults, payload.format);
              }
            }
          } catch { /* malformed SSE line, skip */ }
        }
      }

    } catch (err) {
      panel.innerHTML = `<div class="error-msg">ç½‘ç»œé”™è¯¯ / Network error: ${err.message}</div>`;
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'æŸ¥æ‰¾å¼•ç”¨ / Find Citations';
    }
  }

  function renderResults(results, fmt) {
    const panel = document.getElementById('results-panel');

    if (!results.length) {
      panel.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><p>æœªæ£€æµ‹åˆ°éœ€è¦å¼•ç”¨çš„å¥å­ï¼Œ<br/>æˆ–æ–‡æœ¬ä¸­å·²åŒ…å«å¼•ç”¨æ ‡æ³¨ã€‚<br/><br/>No sentences requiring citations were detected.</p></div>`;
      return;
    }

    let html = `<div class="result-header">
      <span class="result-count">æ£€æµ‹åˆ° ${results.length} ä¸ªéœ€å¼•ç”¨çš„å¥å­ / ${results.length} sentence(s) need citations</span>
      <div class="export-group">
        <button class="btn-export" onclick="exportAll('txt')">TXT</button>
        <button class="btn-export" onclick="exportAll('bib')">BibTeX</button>
        <button class="btn-export" onclick="exportAll('ris')">RIS</button>
        <button class="btn-export" onclick="exportAll('csv')">CSV</button>
      </div>
    </div>`;

    results.forEach((r, i) => {
      const bodyId = `card-body-${i}`;
      html += `<div class="result-card">
        <div class="card-toggle" onclick="toggleCard('${bodyId}', this)">
          <div>
            <div class="sentence-label">
              å¥å­ ${i + 1} / Sentence ${i + 1}
              ${r.reason ? `<span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted);margin-left:6px;">â€” ${escHtml(r.reason)}</span>` : ''}
            </div>
            <div class="sentence-text">${escHtml(r.sentence)}</div>
          </div>
          <span class="toggle-icon">â–²</span>
        </div>
        <div class="card-body" id="${bodyId}">
        <div class="citations-label" style="margin-top:8px;">æ¨èå¼•ç”¨ (${fmt}) / Suggested Citations</div>`;

      r.citations.forEach((c, ci) => {
        const idBase = `cit-${i}-${ci}`;
        html += `<div class="citation-item">
          <div class="citation-body">
            <div class="citation-formatted" id="${idBase}">${escHtml(c.formatted)}</div>
            <div class="citation-meta">`;

        if (c.year) html += `<span class="citation-tag">${c.year}</span>`;
        if (c.venue) html += `<span class="citation-tag">${escHtml(c.venue)}</span>`;
        if (c.citation_count != null) html += `<span class="citation-tag">å¼•ç”¨ ${c.citation_count}</span>`;
        if (c.pdf_url) html += `<span class="citation-tag" style="background:#e6f4ea;color:#1a7f37;">Open Access</span>`;
        if (c.doi_valid === true)  html += `<span class="citation-tag" style="background:#e6f4ea;color:#1a7f37;">DOI âœ“</span>`;
        if (c.doi_valid === false) html += `<span class="citation-tag" style="background:#fff1f0;color:#cf1322;">DOI âœ—</span>`;

        html += `</div>`;

        if (c.abstract) {
          const absId = `abs-${i}-${ci}`;
          const preview = c.abstract.length > 200 ? escHtml(c.abstract.slice(0, 200)) + 'â€¦' : escHtml(c.abstract);
          const full = escHtml(c.abstract);
          const hasMore = c.abstract.length > 200;
          html += `<div class="citation-abstract" id="${absId}-preview">${preview}</div>`;
          if (hasMore) {
            html += `<div class="citation-abstract" id="${absId}-full" style="display:none;">${full}</div>`;
            html += `<button class="btn-abstract-toggle" onclick="toggleAbstract('${absId}', this)">å±•å¼€æ‘˜è¦ â–¾</button>`;
          }
        }

        const linkUrl = c.pdf_url || c.url;
        if (linkUrl) {
          const label = c.pdf_url ? `PDF: ${escHtml(c.pdf_url)}` : escHtml(c.url);
          html += `<a class="citation-link" href="${escHtml(linkUrl)}" target="_blank" rel="noopener">${label}</a>`;
        }

        html += `</div>
          <button class="btn-copy" onclick="copyCitation('${idBase}', this)">å¤åˆ¶</button>
        </div>`;
      });

      html += `</div></div>`;  // close card-body, result-card
    });

    panel.innerHTML = html;
    // Set initial max-height for animation
    document.querySelectorAll('.card-body').forEach(el => {
      el.style.maxHeight = el.scrollHeight + 'px';
    });

    // Highlight detected sentences in the input text
    const inputText = document.getElementById('text-input').value;
    const hlDiv = document.getElementById('text-highlight');
    if (results.length && inputText) {
      let highlighted = escHtml(inputText);
      results.forEach(r => {
        const escaped = escHtml(r.sentence);
        // Replace first occurrence only (exact match after HTML escaping)
        highlighted = highlighted.replace(escaped, `<mark>${escaped}</mark>`);
      });
      hlDiv.innerHTML = highlighted;
      hlDiv.style.display = '';
    } else {
      hlDiv.style.display = 'none';
    }
  }

  function copyCitation(id, btn) {
    const el = document.getElementById(id);
    if (!el) return;
    const text = el.textContent;
    navigator.clipboard.writeText(text).then(() => {
      btn.textContent = 'å·²å¤åˆ¶ âœ“';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'å¤åˆ¶';
        btn.classList.remove('copied');
      }, 1800);
    }).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      btn.textContent = 'å·²å¤åˆ¶ âœ“';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'å¤åˆ¶'; btn.classList.remove('copied'); }, 1800);
    });
  }

  function exportAll(type = 'txt') {
    if (!lastResults.length) return;
    const fmt = document.getElementById('format-select').value.toUpperCase();
    let out = '', mimeType = 'text/plain;charset=utf-8', ext = type;

    if (type === 'txt') {
      out = `å­¦æœ¯å¼•ç”¨åŠ©æ‰‹å¯¼å‡º / Research Citation Assistant Export\n`;
      out += `æ ¼å¼ / Format: ${fmt}\n`;
      out += `æ—¥æœŸ / Date: ${new Date().toLocaleDateString()}\n\n`;
      out += '='.repeat(60) + '\n\n';
      lastResults.forEach((r, i) => {
        out += `[å¥å­ ${i + 1}] ${r.sentence}\n\n`;
        r.citations.forEach((c, ci) => {
          out += `  [${ci + 1}] ${c.formatted}`;
          if (c.pdf_url || c.url) out += `\n       ${c.pdf_url || c.url}`;
          out += '\n';
        });
        out += '\n';
      });
    } else if (type === 'bib') {
      const seen = new Set();
      lastResults.forEach(r => {
        r.citations.forEach(c => {
          if (c.bibtex && !seen.has(c.bibtex)) {
            seen.add(c.bibtex);
            out += c.bibtex + '\n\n';
          }
        });
      });
      mimeType = 'text/plain;charset=utf-8';
    } else if (type === 'ris') {
      const seen = new Set();
      lastResults.forEach(r => {
        r.citations.forEach(c => {
          if (c.ris && !seen.has(c.ris)) {
            seen.add(c.ris);
            out += c.ris + '\n\n';
          }
        });
      });
    } else if (type === 'csv') {
      const esc = v => `"${String(v || '').replace(/"/g, '""')}"`;
      out = 'Sentence,Title,Year,Venue,Citation Count,Formatted,URL\n';
      lastResults.forEach(r => {
        r.citations.forEach(c => {
          out += [r.sentence, c.title, c.year, c.venue, c.citation_count, c.formatted, c.pdf_url || c.url]
            .map(esc).join(',') + '\n';
        });
      });
      mimeType = 'text/csv;charset=utf-8';
    }

    const blob = new Blob([out], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `citations_${fmt}_${Date.now()}.${ext}`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function toggleAbstract(absId, btn) {
    const preview = document.getElementById(absId + '-preview');
    const full = document.getElementById(absId + '-full');
    if (!preview || !full) return;
    if (full.style.display === 'none') {
      preview.style.display = 'none';
      full.style.display = '';
      btn.textContent = 'æ”¶èµ·æ‘˜è¦ â–´';
    } else {
      full.style.display = 'none';
      preview.style.display = '';
      btn.textContent = 'å±•å¼€æ‘˜è¦ â–¾';
    }
  }

  function toggleCard(bodyId, toggleEl) {
    const body = document.getElementById(bodyId);
    if (!body) return;
    const icon = toggleEl.querySelector('.toggle-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      body.style.maxHeight = body.scrollHeight + 'px';
      if (icon) icon.style.transform = 'rotate(0deg)';
    } else {
      body.style.maxHeight = body.scrollHeight + 'px';
      requestAnimationFrame(() => {
        body.classList.add('collapsed');
      });
      if (icon) icon.style.transform = 'rotate(180deg)';
    }
  }

  function updateStats() {
    const text = document.getElementById('text-input').value;
    const chars = text.length;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    document.getElementById('text-stats').textContent = `${words} è¯ / ${chars} å­—ç¬¦`;
    document.getElementById('text-highlight').style.display = 'none';
  }

  function escHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyTheme(dark) {
    document.documentElement.setAttribute('data-theme', dark ? 'dark' : '');
    document.getElementById('theme-btn').textContent = dark ? 'â˜€ï¸' : 'ğŸŒ™';
  }

  function toggleTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const next = !isDark;
    applyTheme(next);
    localStorage.setItem('theme', next ? 'dark' : '');
  }

  // Apply saved theme on load
  applyTheme(localStorage.getItem('theme') === 'dark');

  // â”€â”€ History (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const HISTORY_KEY = 'citation_history';
  const HISTORY_MAX = 5;

  function loadHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
    catch { return []; }
  }

  function saveHistory(text, results, format) {
    const history = loadHistory();
    const entry = {
      text,
      results,
      format,
      timestamp: Date.now(),
      preview: text.slice(0, 70).trim(),
    };
    // Remove duplicate text entries
    const filtered = history.filter(h => h.text !== text);
    filtered.unshift(entry);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(filtered.slice(0, HISTORY_MAX)));
    renderHistory();
  }

  function renderHistory() {
    const history = loadHistory();
    const section = document.getElementById('history-section');
    const list = document.getElementById('history-list');
    const count = document.getElementById('history-count');
    if (!history.length) { section.style.display = 'none'; return; }
    section.style.display = '';
    count.textContent = history.length;
    list.innerHTML = history.map((h, i) => {
      const t = new Date(h.timestamp);
      const time = `${t.getMonth()+1}/${t.getDate()} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
      return `<div class="history-item" onclick="restoreHistory(${i})">
        <span class="history-item-time">${time}</span>
        <span class="history-item-text">${escHtml(h.preview)}â€¦</span>
        <span class="history-item-del" onclick="deleteHistory(event,${i})">Ã—</span>
      </div>`;
    }).join('');
  }

  function toggleHistory() {
    const list = document.getElementById('history-list');
    const icon = document.getElementById('history-toggle-icon');
    const open = list.style.display === 'none';
    list.style.display = open ? '' : 'none';
    icon.textContent = open ? 'â–¼' : 'â–¶';
  }

  function restoreHistory(idx) {
    const history = loadHistory();
    const h = history[idx];
    if (!h) return;
    document.getElementById('text-input').value = h.text;
    document.getElementById('format-select').value = h.format || 'apa';
    updateStats();
    lastResults = h.results;
    renderResults(h.results, (h.format || 'apa').toUpperCase());
  }

  function deleteHistory(e, idx) {
    e.stopPropagation();
    const history = loadHistory();
    history.splice(idx, 1);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderHistory();
  }

  // Init history on load
  renderHistory();

  // Allow Ctrl+Enter to submit
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      findCitations();
    }
  });
</script>

</body>
</html>
